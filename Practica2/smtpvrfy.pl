# Verfica si un usuario existe en un servidor SMTP
# Recibe como argumento la direccion del servidor y el nombre de usuario
#
# Autor: Jose Luis Torres Rodriguez
#
#!/usr/bin/perl
use strict;
use Net::SMTP;
use Sys::Hostname;

if ($#ARGV != 1){
    print "Error: los argumentos estan mal.\n";
    print "Uso: $0 ip-servidor nombre-usuario\n";
    exit(1);
}

# Tomamos el nombre de nuestro equipo para incluirlo en la instruccion HELO
my $selfname = hostname();

# Leemos la IP del host y el nombre de usuario a verificar
my ($host, $user) = @ARGV;

print "Verificando ".$user." en ".$host."\n";

# Intentamos establecer la conexion
# Se puede eliminar el '#' antes de Debug para hacer un seguimiento de la conexion
my $smtp = Net::SMTP->new($host, Hello => $selfname, Timeout => 30#, Debug   => 1,
    );

# Verificamos si nos pudimos conectar
if (! $smtp){
    print "No se pudo establecer la conexion con $host\n";
    exit(1);
}

# Enviamos la instruccion para verificar el usuario
$smtp->datasend("VRFY ".$user."@".$host."\n");
$smtp->dataend;

# Revisamos los codigos devueltos
if ($smtp->code == 250){
    print "El usuario ".$user." existe en el servidor.\n";
}
else {
    if ($smtp->code == 251){
	print "El usuario".$user." no existe localmente, se aplica forward.\n";
    }
    else{
	if ($smtp->code == 252){
	    print "No se puede verificar el usuario ".$user.".\n";
	}
	else{
	    print "El usuario ".$user."no existe o sucedio un error al verificar";
	}
    }
}
# Cerramos la conexion
$smtp->quit;
